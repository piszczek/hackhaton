{% extends 'base.html.twig' %}

{% block body %}
    <h3>My Google Maps Demo</h3>

    <div id="map" style="height: 400px;width: 100%"></div>
    <div id="polyline-modal">
    </div>
    <script src="/static/js/Router.js"></script>
    <script>
        const editPolyline = (polylineId) => {
            const modal = document.querySelector('#polyline-modal');
            const router = new Router();

            modal.classList.add('show');
            router.makeRequest({
                'method': 'GET',
                'url': '{{ path('section_edit', {'id': '__ID__'}) }}'.replace('__ID__', polylineId),
                'headers': {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            }).then(response => {
                modal.innerHTML = response;
                const sectionForm = document.querySelector('form');
                sectionForm.addEventListener('submit', event => {
                    event.preventDefault();

                    const formData = new FormData(sectionForm);

                    router.makeRequest({
                        'method': 'POST',
                        'url': sectionForm.getAttribute('action'),
                        'headers': {
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        'parameters': formData
                    }).then(response => {
                        console.log(response);
                        modal.innerHTML = null;
                    }).catch(error => {
                        console.error(error);
                    })
                })
            }).catch(error => {
                alert('Error occurred :( Please, refresh site and try again!');
                console.error(error);
            });
        };

        async function initMap() {
            const routes = JSON.parse('{{ sections|raw }}');
            const refinery = {lat: 52.588353, lng: 19.672254};
            const map = new google.maps.Map(
                document.getElementById('map'), {zoom: 13.98, center: refinery}
            );

            for (let route of routes) {
                let routePolyline = new google.maps.Polyline({
                    path: [route.startPoint, route.endPoint],
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 4,
                    elementId: route.id
                });
                routePolyline.setMap(map);
                google.maps.event.addListener(routePolyline, 'click', () => editPolyline(routePolyline['elementId']))
            }
        }
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-a3f8Q6ZosKYXXjaIUoO_ad_yPq-iVjI&callback=initMap">
    </script>
{% endblock %}
